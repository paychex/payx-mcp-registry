name: Sync with Upstream Registry

on:
  schedule:
    - cron: '0 2 * * *'  # Daily at 2 AM UTC
  workflow_dispatch:  # Allow manual trigger for testing
  push:
    branches:
      - main
    paths:
      - '.github/workflows/sync-upstream.yml'  # Only trigger when workflow changes

permissions:
  contents: write  # Required to push changes
  pull-requests: write  # Required to create PRs

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history for proper sync
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/modelcontextprotocol/registry.git || true
          git remote -v
      
      - name: Fetch upstream changes
        run: |
          git fetch upstream
          git fetch origin
      
      - name: Check for updates
        id: check_updates
        run: |
          # Get the latest commit from upstream main
          UPSTREAM_COMMIT=$(git rev-parse upstream/main)
          CURRENT_COMMIT=$(git rev-parse origin/main)
          
          echo "Upstream commit: $UPSTREAM_COMMIT"
          echo "Current commit: $CURRENT_COMMIT"
          
          if [ "$UPSTREAM_COMMIT" != "$CURRENT_COMMIT" ]; then
            echo "updates_available=true" >> $GITHUB_OUTPUT
            echo "âœ… Updates available from upstream"
          else
            echo "updates_available=false" >> $GITHUB_OUTPUT
            echo "âœ… Already up to date with upstream"
          fi
      
      - name: Merge upstream changes
        if: steps.check_updates.outputs.updates_available == 'true'
        id: merge
        run: |
          set +e  # Don't exit on error
          
          # Attempt to merge upstream/main directly into main
          git merge upstream/main -m "Merge upstream changes from modelcontextprotocol/registry" \
            --no-edit
          
          MERGE_STATUS=$?
          
          if [ $MERGE_STATUS -eq 0 ]; then
            echo "merge_status=success" >> $GITHUB_OUTPUT
            echo "âœ… Merge completed successfully"
          else
            echo "merge_status=conflicts" >> $GITHUB_OUTPUT
            echo "âš ï¸ Merge conflicts detected"
            
            # Abort the merge
            git merge --abort
            
            # List conflicted files in summary
            echo "## âš ï¸ Merge Conflicts Detected" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Automatic merge failed. Manual intervention required." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### To resolve manually:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
            echo "git fetch upstream" >> $GITHUB_STEP_SUMMARY
            echo "git merge upstream/main" >> $GITHUB_STEP_SUMMARY
            echo "# Resolve conflicts, then:" >> $GITHUB_STEP_SUMMARY
            echo "git add ." >> $GITHUB_STEP_SUMMARY
            echo "git commit" >> $GITHUB_STEP_SUMMARY
            echo "git push origin main" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            
            exit 1
          fi
      
      - name: Push changes to main
        if: steps.check_updates.outputs.updates_available == 'true' && steps.merge.outputs.merge_status == 'success'
        run: |
          git push origin main
          echo "âœ… Successfully pushed upstream changes to main"
      
      - name: Summary
        if: always()
        run: |
          echo "## Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.check_updates.outputs.updates_available }}" == "true" ]; then
            echo "- âœ… Updates were available from upstream" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ”€ Merge status: ${{ steps.merge.outputs.merge_status }}" >> $GITHUB_STEP_SUMMARY
            
            if [ "${{ steps.merge.outputs.merge_status }}" == "success" ]; then
              echo "- âœ… Changes successfully merged and pushed to main" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "- âœ… Already up to date with upstream" >> $GITHUB_STEP_SUMMARY
            echo "- No action needed" >> $GITHUB_STEP_SUMMARY
          fi
          