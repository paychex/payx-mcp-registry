name: Sync with Upstream Registry

on:
  schedule:
    - cron: '0 2 * * *'  # Daily at 2 AM UTC
  workflow_dispatch:  # Allow manual trigger for testing
  push:
    branches:
      - main
    paths:
      - '.github/workflows/sync-upstream.yml'  # Only trigger when workflow changes

permissions:
  contents: write  # Required to push changes
  pull-requests: write  # Required to create PRs

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history for proper sync
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/modelcontextprotocol/registry.git || true
          git remote -v
      
      - name: Fetch upstream changes
        run: |
          git fetch upstream
          git fetch origin
      
      - name: Check for updates
        id: check_updates
        run: |
          # Get the latest commit from upstream main
          UPSTREAM_COMMIT=$(git rev-parse upstream/main)
          CURRENT_COMMIT=$(git rev-parse origin/main)
          
          echo "Upstream commit: $UPSTREAM_COMMIT"
          echo "Current commit: $CURRENT_COMMIT"
          
          if [ "$UPSTREAM_COMMIT" != "$CURRENT_COMMIT" ]; then
            echo "updates_available=true" >> $GITHUB_OUTPUT
            echo "âœ… Updates available from upstream"
          else
            echo "updates_available=false" >> $GITHUB_OUTPUT
            echo "âœ… Already up to date with upstream"
          fi
      
      - name: Create sync branch
        if: steps.check_updates.outputs.updates_available == 'true'
        run: |
          BRANCH_NAME="sync-upstream-$(date +%Y%m%d-%H%M%S)"
          echo "SYNC_BRANCH=$BRANCH_NAME" >> $GITHUB_ENV
          
          git checkout -b "$BRANCH_NAME"
          echo "Created branch: $BRANCH_NAME"
      
      - name: Merge upstream changes
        if: steps.check_updates.outputs.updates_available == 'true'
        id: merge
        run: |
          set +e  # Don't exit on error
          
          # Attempt to merge upstream/main into our sync branch
          git merge upstream/main -m "Merge upstream changes from modelcontextprotocol/registry" \
            --no-edit \
            --allow-unrelated-histories
          
          MERGE_STATUS=$?
          
          if [ $MERGE_STATUS -eq 0 ]; then
            echo "merge_status=success" >> $GITHUB_OUTPUT
            echo "âœ… Merge completed successfully"
          else
            echo "merge_status=conflicts" >> $GITHUB_OUTPUT
            echo "âš ï¸ Merge conflicts detected"
            
            # List conflicted files
            echo "## Conflicted Files:" >> $GITHUB_STEP_SUMMARY
            git diff --name-only --diff-filter=U | tee -a $GITHUB_STEP_SUMMARY
          fi
      
      - name: Push sync branch
        if: steps.check_updates.outputs.updates_available == 'true'
        run: |
          git push origin "$SYNC_BRANCH"
          echo "âœ… Pushed branch: $SYNC_BRANCH"
      
      - name: Create Pull Request
        if: steps.check_updates.outputs.updates_available == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Determine PR title and body based on merge status
          if [ "${{ steps.merge.outputs.merge_status }}" == "success" ]; then
            PR_TITLE="ðŸ”„ Sync with upstream registry"
            PR_BODY="## Automated Upstream Sync
          
          This PR syncs changes from the [upstream modelcontextprotocol/registry](https://github.com/modelcontextprotocol/registry).
          
          ### âœ… Status
          - Merge completed successfully with no conflicts
          - Ready for review and merge
          
          ### ðŸ“‹ Changes
          Review the commits to see what's new from upstream.
          
          ### ðŸ” Testing
          - Verify that local development still works: \`make dev-compose\`
          - Run tests: \`make test\`
          - Check for any breaking changes in the commits
          
          ---
          *Automatically generated by the sync-upstream workflow*"
          else
            PR_TITLE="ðŸ”„ Sync with upstream registry (âš ï¸ conflicts)"
            PR_BODY="## Automated Upstream Sync - Manual Resolution Required
          
          This PR syncs changes from the [upstream modelcontextprotocol/registry](https://github.com/modelcontextprotocol/registry).
          
          ### âš ï¸ Status
          - Merge conflicts detected - manual resolution required
          - See the workflow run for details on conflicted files
          
          ### ðŸ“‹ To Resolve
          \`\`\`bash
          git fetch origin
          git checkout $SYNC_BRANCH
          # Resolve conflicts manually
          git add .
          git commit -m 'Resolve merge conflicts'
          git push origin $SYNC_BRANCH
          \`\`\`
          
          ### ðŸ” Testing After Resolution
          - Verify that local development still works: \`make dev-compose\`
          - Run tests: \`make test\`
          - Check for any breaking changes in the commits
          
          ---
          *Automatically generated by the sync-upstream workflow*"
          fi
          
          # Create the PR
          gh pr create \
            --title "$PR_TITLE" \
            --body "$PR_BODY" \
            --base main \
            --head "$SYNC_BRANCH"
          
          echo "âœ… Pull request created"
      
      - name: Summary
        if: always()
        run: |
          echo "## Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.check_updates.outputs.updates_available }}" == "true" ]; then
            echo "- âœ… Updates were available from upstream" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ”€ Merge status: ${{ steps.merge.outputs.merge_status }}" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸŒ¿ Branch created: \`$SYNC_BRANCH\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âœ… Already up to date with upstream" >> $GITHUB_STEP_SUMMARY
            echo "- No action needed" >> $GITHUB_STEP_SUMMARY
          fi
          